"use client";

import { useState } from "react";

import { useAuthStore } from "@/store/authStore";
import { useUser } from "@/hooks/useUser";


export default function Password() {
  const [currentPw, setCurrentPw] = useState("");
  const [newPw, setNewPw] = useState("");
  const [confirmPw, setConfirmPw] = useState("");
  const { handleChangePasswd } = useUser();
  const { user } = useAuthStore();
  const [ checkFail, setCheckFail ] = useState(false);
  const [ failInfo, setFailInfo ] = useState<string | undefined>();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (newPw !== confirmPw) {
      setCheckFail(true);
      setFailInfo("새 비밀번호가 일치하지 않습니다.");
      return;
    }

    if (!user || !user.email) {
      // 사용자 정보가 없을 경우
      return;
    }
    
    try {
      const result = await handleChangePasswd(user.email, currentPw, newPw);
      
      if(result.success) {
        window.location.href ='/mypage';
      } else {
        setCheckFail(true);
        setFailInfo(result.message);
      }
    } catch(err: any) {
      console.error("비밀번호 변경 실패" + err.message);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <h2 className="text-2xl font-bold mb-1">비밀번호 변경</h2>
      <p className="text-gray-600 mb-8">보안을 위해 개인정보를 안전하게 보호하세요</p>

      <div className="space-y-6">
        <div className="flex items-center">
          <label className="w-40 text-gray-800">현재 비밀번호</label>
          <input
            type="password"
            placeholder="비밀번호를 입력하세요"
            className="flex-1 border border-gray-300 p-2 rounded"
            value={currentPw}
            onChange={(e) => setCurrentPw(e.target.value)}
          />
        </div>

        <div className="flex items-center">
          <label className="w-40 text-gray-800">새 비밀번호</label>
          <input
            type="password"
            placeholder="새 비밀번호를 입력하세요"
            className="flex-1 border border-gray-300 p-2 rounded"
            value={newPw}
            onChange={(e) => setNewPw(e.target.value)}
          />
        </div>

        <div className="flex items-center">
          <label className="w-40 text-gray-800">새 비밀번호 확인</label>
          <input
            type="password"
            placeholder="새 비밀번호를 한번 더 입력하세요"
            className="flex-1 border border-gray-300 p-2 rounded"
            value={confirmPw}
            onChange={(e) => setConfirmPw(e.target.value)}
          />
        </div>
      </div>

      <hr className="my-8 border-gray-300" />

      <div className="text-sm text-gray-500 leading-relaxed mb-6">
        비밀번호는 도난방지, 보안설정을 위하여 3개월~6개월 사이에 주기적으로 변경하는 것이 안전합니다.
        <br />
        8~16자의 영문 대/소문자, 숫자, 특수기호를 조합하여 사용할 수 있습니다.
        <br />
        생년월일, 전화번호 등 개인정보와 관련된 숫자, 연속된 숫자, 연속된 키보드 배열과 같이 쉬운 비밀번호는 자제바랍니다.
        <br />
        현재 사용했던 비밀번호와 동일한 비밀번호로 변경할 수 없습니다.
      </div>

      <button
        type="submit"
        className="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded"
      >
        확인
      </button>
      {checkFail &&
      <p className="text-sm text-center text-red-600 py-4">{failInfo}</p>
      }
    </form>
  );
}
